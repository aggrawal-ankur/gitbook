# Lets Get Chunky

_**15 September 2025**_

***

In brief, the whole story of dlmalloc revolves around chunks. And the story is quite big so we need a path to follow. Let's try to map the surface first.

## How chunks are formed?

When a process start to exist, it rarely requires dynamic memory allocation. There are shared libraries in the memory mapped region but that's not dynamic memory allocation.

When the code calls `malloc` , this is when the idea of dynamic memory allocation starts to exist for that process.

Suppose the ask was `malloc(20)`. We know that a pointer in heap is returned such that it is suitable for any built-in type. We are asking for 20 bytes.

But memory is managed in terms of pages. Now there is a difference in how the allocator is managing memory and how the kernel is managing memory. To solve this problem, the kernel allocates in terms of pages, while the allocator divides the page into chunks. Simple.

Since the smallest page can be 1 page only, assuming 4 KiB size, for `malloc(20)` request, the allocator receives 4 KiB from the kernel, that is 4096 bytes.

These 4096 bytes is our **arena**, the total unallocated pool of memory, that the allocator is now going to manage.

Since a chunk of 20 bytes was requested, 20 bytes will be carved out from 4096 bytes of heap memory and will be allocated to the process.

* In this process, the program break would have increased by 20 bytes.

Now we have `4076` bytes of unallocated memory and one **in-use chunk** of 20 bytes.

* That's how **the first in-use chunk** comes into existence for a process.

Suppose we had few more allocations following, `malloc(10); malloc(15); malloc(28); malloc(22);`.

* A total of `110` bytes is request here. And we have plenty in the arena.
* After this allocation, we have `3066` bytes of unallocated memory and **five in-use chunks** or varying sizes.

Now the process is coming to an end and we are freeing every allocation.

*   ```
    free(20); free(10); free(15); free(28); free(32);
    ```

    and the process died.

In this scenario, there were no free chunks and honestly, there was no need as well.

To visualize this, we can use an ASCII drawing which represents byte addressable heap.

```
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
```

* Looks pretty, huh? I want a complement on this. Just kidding.
* If anyone is wondering how i obtained these upper scores (macron) and angles, checkout this article on Wikipedia, [Box-drawing characters](https://en.wikipedia.org/wiki/Box-drawing_characters). I first saw these characters in VS Code's terminal specifically in Kali Linux and ever since I can't get how great they look.
* Anyways, back to the topic. Such diversions are healthy so yeah.

***

So the above example can be mapped as:

```
p = malloc(20);
q = malloc(10);
r = malloc(15);
s = malloc(18);
t = malloc(32);

┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| p. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  1    2    3    4    5    6    7    8    9    10
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    | .p |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  11   12   13   14   15   16   17   18   19   20
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| q. |    |    |    |    |    |    |    |    | .q |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  21   22   23   24   25   26   27   28   29   30
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| r. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  31   32   33   34   35   36   37   38   39   40
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    | .r | s. |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  41   42   43   44   45   46   47   48   49   50
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  51   52   53   54   55   56   57   58   59   60
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    | .s | t. |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  61   62   63   64   65   66   67   68   69   70
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  71   72   73   74   75   76   77   78   79   80
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  81   82   83   84   85   86   87   88   89   90
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    | .t |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  91   92   93   94   95   96   97   98   99   100
```

This proves that there was no need for "free chunks" at all.

***

Let's take another example.

```
p = malloc(10);
q = malloc(20);
free(10);
r = malloc(30);
free(20);
s = malloc(32);
t = malloc(26);         goes in the first group from cache bins
```

Let's map this on our ASCII grid.

```
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| p. |    |    |    |    |    |    |    |    | .p |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  1    2    3    4    5    6    7    8    9    10
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| q. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  11   12   13   14   15   16   17   18   19   20
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    | .q |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  21   22   23   24   25   26   27   28   29   30
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  31   32   33   34   35   36   37   38   39   40
  .
  .
```

Since there is a free in between, this changes the dynamic and that's why we have to stop.

Upon `free(p)` , the state of memory becomes this:

```
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  1    2    3    4    5    6    7    8    9    10
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| q. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  11   12   13   14   15   16   17   18   19   20
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    | .q |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  21   22   23   24   25   26   27   28   29   30
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  31   32   33   34   35   36   37   38   39   40
  .
  .
```

* And that's how the first **free chunk** comes into existence.

Moving next comes `r`.

```
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  1    2    3    4    5    6    7    8    9    10
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| q. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  11   12   13   14   15   16   17   18   19   20
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    | .q |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  21   22   23   24   25   26   27   28   29   30
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| r. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  31   32   33   34   35   36   37   38   39   40
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  41   42   43   44   45   46   47   48   49   50
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    | .r |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  51   52   53   54   55   56   57   58   59   60
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  61   62   63   64   65   66   67   68   69   70
  .
  .
```

Again, another free, `free(q)`. And the state of memory is like this:

```
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  1    2    3    4    5    6    7    8    9    10
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  11   12   13   14   15   16   17   18   19   20
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  21   22   23   24   25   26   27   28   29   30
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| r. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  31   32   33   34   35   36   37   38   39   40
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  41   42   43   44   45   46   47   48   49   50
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    | .r |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  51   52   53   54   55   56   57   58   59   60
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  61   62   63   64   65   66   67   68   69   70
  .
  .
```

We already had a free chunk of `10` bytes and now we have another `20` bytes. Is there any point in keeping these chunks different? Can we bring them together, like collapse them into one? Off course we can do that.

* So now we have one big free chunk of size 30 bytes and one in-use chunk of 30 bytes.

Next we have `malloc(32)`.

* We already had a free chunk but that free chunk is sized 30 bytes and we need 32.
* So, we can't use that portion of memory. So, we have to allocate after `r`.

```
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  1    2    3    4    5    6    7    8    9    10
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  11   12   13   14   15   16   17   18   19   20
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  21   22   23   24   25   26   27   28   29   30
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| r. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  31   32   33   34   35   36   37   38   39   40
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  41   42   43   44   45   46   47   48   49   50
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    | .r |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  51   52   53   54   55   56   57   58   59   60
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| s. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  61   62   63   64   65   66   67   68   69   70
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  71   72   73   74   75   76   77   78   79   80
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  81   82   83   84   85   86   87   88   89   90
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    | .s |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  91   92   93   94   95   96   97   98   99   100
```

Next we have `malloc(26)`. This one is special as now we lack forward memory in our arena. But there is a free chunk of 30 bytes, so we carve 26 bytes out of it for `t`. And the final state of our arena would be:

```
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| t. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  1    2    3    4    5    6    7    8    9    10
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  11   12   13   14   15   16   17   18   19   20
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    | .t | // | // | // | // |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  21   22   23   24   25   26   27   28   29   30
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| r. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  31   32   33   34   35   36   37   38   39   40
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  41   42   43   44   45   46   47   48   49   50
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    | .r |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  51   52   53   54   55   56   57   58   59   60
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
| s. |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  61   62   63   64   65   66   67   68   69   70
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  71   72   73   74   75   76   77   78   79   80
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    |    |    |    |    |    |    |    |    |    |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  81   82   83   84   85   86   87   88   89   90
┌────┐────┐────┐────┐────┐────┐────┐────┐────┐────┐
|    | .s | // | // | // | // | // | // | // | // |
└────┘────┘────┘────┘────┘────┘────┘────┘────┘────┘
  91   92   93   94   95   96   97   98   99   100
```

We have  in-use chunks, 1 free chunk and 1 unallocated memory (like free chunk only).

Suppose we have to do `malloc(12)`. Although we have 12 bytes free, but sadly we can't utilize them. This is what external fragmentation looks like.
